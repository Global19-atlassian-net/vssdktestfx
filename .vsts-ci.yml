trigger:
  batch: true
  branches:
    include: ["master"]
  paths:
    exclude: ["doc", "*.md"]

queue: VSEng-MicroBuildVS2019

steps:
- powershell: |
    "$env:userprofile\.nuget\packages", "$env:LocalAppData\NuGet\Cache", "$env:AppData\tsd-cache" |% {
      if (Test-Path $_) { Remove-Item $_ -Recurse -Force }
    }
  displayName: Purge package caches
  condition: and(succeeded(), eq(variables['system.collectionId'], '011b8bdf-6d56-4f87-be0d-0092136884d9'))

- task: UseDotNet@2
  inputs:
    packageType: sdk
    useGlobalJson: true

- task: MicroBuildSigningPlugin@1
  inputs:
    signType: $(SignType)
    esrpSigning: true
    zipSources: false

- task: NuGetCommand@2
  inputs:
    restoreSolution: '**\*.sln'
    feedsToUse: config
    nugetConfigPath: src/nuget.config
    externalFeedCredentials: mseng VS-PrivateAssemblies
  displayName: Nuget restore packages

- task: VSBuild@1
  inputs:
    msbuildArgs: /t:build,pack
    platform: $(BuildPlatform)
    configuration: $(BuildConfiguration)
  displayName: Build Visual Studio solution

- task: VSTest@2
  inputs:
    testAssemblyVer2: bin/**/$(BuildConfiguration)/**/*tests*.dll
    codeCoverageEnabled: true
    runInParallel: true
    vsTestVersion: latest
    pathtoCustomTestAdapters: $(Build.SourcesDirectory)\bin\Microsoft.VisualStudio.Sdk.TestFramework.Tests\$(BuildConfiguration)\net46

- task: MicroBuildCleanup@1
  condition: succeededOrFailed()

- task: CopyFiles@1
  inputs:
    Contents: |
      bin/**/$(BuildConfiguration)/*.nupkg
    TargetFolder: $(Build.ArtifactStagingDirectory)/deployables
    flattenFolders: true
  displayName: Collecting deployables

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)/deployables
    ArtifactName: deployables
    ArtifactType: Container
  displayName: Publish deployables artifacts
  condition: and(succeeded(), ne(variables['system.pullrequest.isfork'], true))

- task: PublishSymbols@2
  inputs:
    SymbolsFolder: $(Build.SourcesDirectory)/bin
    SearchPattern: '**/*.pdb'
    IndexSources: false
    SymbolServerType: TeamServices
  displayName: Publish symbols to symbol server
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
